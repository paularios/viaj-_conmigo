<!DOCTYPE html>
<html>
	<head>
	<title>Viajá Conmigo</title>
	<meta name="viewport"
		content="minimal-ui, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style"
		content="black-translucent" />
	<meta name="msapplication-tap-highlight" content="no" />
	<meta name="format-detection" content="telephone=no" />
	
	<link rel="shortcut icon" href="">
	
	
	<link rel="stylesheet" href="mobileui/mui.min.css" type="text/css">
	<link rel="stylesheet" href="custom/custom.css" type="text/css">
	
	<script src="phonegap.js"></script>
	<script src="vendors/fastclick.min.js" type="text/javascript"></script>
		<link rel="stylesheet" href="mobileui/mui.min.css" type="text/css">
	    <link rel="stylesheet" href="custom/custom.css" type="text/css">
	
	    <script src="phonegap.js"></script>		
	 	<script src="vendors/fastclick.min.js" type="text/javascript"></script>  	 	
	    
	    <script src="vendors/jquery.min.js" type="text/javascript"></script>
	    <script src="vendors/jquery.animate-enhanced.js" type="text/javascript"></script>
		<script src="vendors/jqwait/jquery.wait.min.js" type="text/javascript"></script>   
	    <script src="vendors/iscroll-min.js" type="text/javascript"></script>
	    
		<script src="mobileui/mui.min.js" type="text/javascript"></script>
	    <script src="custom/custom.js" type="text/javascript"></script>
	</head>
	<body>
	    <div id="mui-screen" class="mui-viewport">
			<div id="mui-screen-page" class="mui-page">
				<div id="mui-viewport" class="mui-viewport">
					
					<!-- PÁGINA DE REGISTRO (primera vez al descargar e instalar la aplicación) -->
					<div id='sign-up-page' class="mui-page">
						<div id="register-header" class= "logo-ppal-header">
							<div class="logo-ppal"></div>
						</div>
						<div class="mui-page-body mui-scrollable">
							<div class= "title-div">Registrarme</div>
							<div class = "form-div">
									<span id="sign-up-alert" class="form-alert-msg">Alerta</span><br>
									<label for="mail">Dirección de correo electrónico:</label>
									<input type="text" size="20" maxlength="50" placeholder="Mail" name="sign-up-mail" id="sign-up-mail" class="field-form">
									<span class="validity"></span>
									<input type="submit" value="Enviar mail" id="sign-up-send-mail-btn" class="form-btn">
									<div id="passwordDiv">
										<label for="mail">Contraseña:</label>
										<input type="password" size="20" maxlength="50" placeholder="Contraseña" name="sign-up-password" id="sign-up-password" class="field-form">
										<input type="submit" value="Entrar" id="sign-up-btn" class="form-btn">
									</div>
							</div>
						</div>
					</div>
					
					<!-- PÁGINA DE LOG-IN -->
					<div id='log-in-page' class="mui-page">
						<div id="log-in-header" class= "logo-ppal-header">
							<div class="logo-ppal"></div>
						</div>
						<div class="mui-page-body mui-scrollable">
							<div class= "title-div">Iniciar sesión</div>
							<div class = "form-div">
									<span id="log-in-alert" class="form-alert-msg">Alerta</span><br>
									<label for="mail">Dirección de correo electrónico:</label>
									<input type="text" size="20" maxlength="50" placeholder="Mail" name="log-in-mail" id="log-in-mail" class="field-form">
									<span class="validity"></span>
									<label for="mail">Contraseña:</label>
									<input type="password" size="20" maxlength="50" placeholder="Contraseña" name="log-in-password" id="log-in-password" class="field-form">
									<span class="validity"></span>
									<input type="submit" value="Entrar" id="log-in-btn" class="form-btn">
							</div>
						</div>
					</div>
					
					<!-- PÁGINA DE PERFIL -->
					<div id='profile-page' class="mui-page">
						<div class="logo-ppal-header">
							<a class="mui-backarrow" href="#"></a>
							<div class="logo-ppal"></div>
						</div>
						<div class="mui-page-body">
							<div class="profile-pic-div">
								<div class= "profile-pic">
									<div id="profile-pic-overlay" class="overlay"> Cambiar foto</div>
								</div>
							</div>
							<div class = "form-div mui-scrollable">
								<label for="nombre">Nombre:</label>
								<input type="text" size="20" maxlength="50" placeholder="Nombre" name="profile-name" id="profile-name" class="field-form">
								<label for="nombre">Apellido:</label>
								<input type="text" size="20" maxlength="50" placeholder="Apellido" name="profile-lastname" id="profile-lastname"  class="field-form">
								<label for="nombre">Nueva contraseña:</label>
								<input type="password" size="20" maxlength="50" placeholder="Nueva contraseña" name="profile-password" id="profile-password" class="field-form">
								<label for="nombre">Confirmar contraseña:</label>
								<input type="password" size="20" maxlength="50" placeholder="Nueva contraseña" name="profile-confirm-password" id="profile-confirm-password" class="field-form">
								<span id="profile-alert" class="form-alert-msg">Alerta</span>
								<input type="submit" value="Enviar" id="profile-btn" class="form-btn">
							</div> 
						</div> 
					</div>
					
					<!-- PÁGINA DE INICIO (MAPA) -->
					<div id="home-page" class="mui-page">
					 	<div class="mui-page-body">
					 		<div id="map"> </div>
					 		<div class="logo-mmal-header">
								<div class="logo-mmal"></div>
							</div>
							<div id="destination-div">
								<input id="destination" type="text" placeholder="¿A dónde querés ir?">
							</div>
							<input type="submit" value="Viajar" id="home-page-btn" class="form-btn" onclick="obtainLatLngFromAddress()">
							<div id="buttons-board">
								<div class="circle-button-div">
									<input type="button" id="home-page-profile-btn" class="circle-button">
								</div>
								<div class="circle-button-div">
									<input type="button" id="home-page-history-btn" class="circle-button">
								</div>
								<div class="circle-button-div">
									<input type="button" id="home-page-notifications-btn" class="circle-button">
								</div>
							</div>
							<div id="ride-panel">
							</div>
						</div>
					</div>					
				</div>	
			</div>	
			
			<!-- mui-screen level panel -->
			<!-- <div id="ride-panel" class="mui-panel">
				<div class="mui-panel-header">
					<div class='mui-panel-title'>Menu</div>
				</div>
				<div class="mui-panel-body">
					<div>
						<ul id='menuoptions' class='mui-list'>
							<li><a id='option1' href="#">Go Home Page</a></li>
							<li><a id='option2' href="#">Go Page 2</a></li>
						</ul>
					</div>
				</div>
			</div>	 -->
				 			 
	    </div>
	    <script>
	    
		    var originCoords = {};
		    var dentinationCoords = {};
		    var originMarker;
		    var destinationMarker;
		    var gmap;
		    var map;
		    
			// ******** DRIVER FUNCTIONS ********
			
		    initMap = function () {
		      navigator.geolocation.getCurrentPosition(
		        function (position){
		          originCoords =  {
		            lat: position.coords.latitude,
		            lng: position.coords.longitude
		          };
		          gmap = GMaps({
		                      div: '#map',
		                      zoom: 13,
		                      lat: originCoords.lat,
		                      lng: originCoords.lng
		                    });
		          map = gmap.map;
		          originMarker = new google.maps.Marker({
		            map: map,
		            icon: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
		            position: new google.maps.LatLng(originCoords.lat,originCoords.lng)
		          });
		          setMap(originCoords, map, gmap); 
		        },function(error){console.log(error);});
		    }
	
		    function setMap(originCoords, map, gmap){
		    	destinationMarker = new google.maps.Marker({
		    		map: map,
		    		draggable: true,
		            icon: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
		            animation: google.maps.Animation.DROP,
		            position: new google.maps.LatLng(originCoords.lat, originCoords.lng)
		        });
		    	destinationMarker.addListener('click', toggleBounce);
		    	destinationMarker.addListener( 'dragend', function (event) {
		            destinationCoords = {
		              lat: this.getPosition().lat(),
		              lng: this.getPosition().lng()
		            }
		            defineRoute(originCoords, destinationCoords, gmap);
		            passengerOriginCoords = {
		            		lat: -34.901086,
		            		lng: -56.176461
		            }
		            passengerOriginMarker = new google.maps.Marker({
			    		map: map,
			    		draggable: true,
			            icon: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
			            animation: google.maps.Animation.DROP,
			            position: new google.maps.LatLng(passengerOriginCoords.lat, passengerOriginCoords.lng)
			        });
		            passengerJoinCoords = passengerJoinCoords(passengerOriginCoords, originCoords, destinationCoords, gmap)
		            console.log(passengerJoinCoords);
		            passengerJoinMarker = new google.maps.Marker({
			    		map: map,
			    		draggable: true,
			            icon: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
			            animation: google.maps.Animation.DROP,
			            position: new google.maps.LatLng(passengerJoinCoords.lat, passengerJoinCoords.lng)
			        });
		    	});
		    }
		    
		    function toggleBounce() {
		    	if (destinationMarker.getAnimation() !== null) {
		    		destinationMarker.setAnimation(null);
		    	} else {
		            destinationMarker.setAnimation(google.maps.Animation.BOUNCE);
		        }
		    }
		    
		    function obtainLatLngFromAddress() {
		    	var address = document.getElementById('destination').value;
		    	var geocoder = new google.maps.Geocoder();
		    	geocoder.geocode({'address': address}, function(results, status){
		    		if (status == 'OK'){
		    			destinationCoords = {
		    				lat: results[0].geometry.location.lat(),
		    				lng: results[0].geometry.location.lng()
		    			}
		    			destinationMarker.setIcon("https://maps.google.com/mapfiles/ms/icons/yellow-dot.png");
		    			destinationMarker.setPosition(results[0].geometry.location);
		    		}
		    	});
		    }
		    
		    function defineRoute(originCoords, destinationCoords, gmap) {
		    	gmap.drawRoute({
		            origin: [originCoords.lat, originCoords.lng],
		            destination: [destinationCoords.lat, destinationCoords.lng],
		            travelMode: 'driving',
		            strokeColor: '#105FD0',
		            strokeOpacity: 0.6,
		            strokeWeight: 6
		        });
		    }
		    
		    // ******** PASSENGER FUNCTIONS ********
		    
		    function obtainMultipleCoordsOverAroute(originCoords, destinationCoords, gmap) {
		    	var coordsLat =[];
	          	var coordsLng = [];
	          	var ponisLatLng = {}
	          	gmap.travelRoute({
	            	origin: [originCoords.lat, originCoords.lng],
	            	destination: [destinationCoords.lat, destinationCoords.lng],
	            	travelMode: 'driving',
	            	strokeColor: '#105FD0',
	            	strokeOpacity: 0.6,
	            	strokeWeight: 6,
	            	step: function(e) {
	              		for(var i = 0; i<e.lat_lngs.length; i++){
	              			coordsLat.push(e.lat_lngs[i].lat());
	              			coordsLng.push(e.lat_lngs[i].lng());
	              		}
	            	}
	          	});
	          	coordsLatLng = {"lat": coordsLat, "lng": coordsLng}
	          	return coordsLatLng;
        	}
		    
	        function passengerJoinCoords(passengerOriginCoords, driverOriginCoords, driverDestinationCoords, gmap) {
	        	coordsOverAroute = obtainMultipleCoordsOverAroute(driverOriginCoords, driverDestinationCoords, gmap);
	        	var originDistance;
	        	var shortestDistance = 0;
	          	var distances = [];
	        	var coordsLat = [];
	        	var coordsLng = [];
	          	var index;
	          	var joinCoords = {};
	        	coordsLat = coordsOverAroute.lat
	        	coordsLng = coordsOverAroute.lng
	        	console.log(coordsLat);
	        	console.log(coordsLat.length);
	        	console.log(coordsLat[0]);
	        	distanceOrigins = mui.util.distanceLatLng(passengerOriginCoords.lat, passengerOriginCoords.lng, coordsLat[0], coordsLng[0], "kilometros");
	        	console.log(distanceOrigins)
	        	for (var i=0; i<coordsLat.length; i++) {
	        		for (var j=0; j<coordsLng.length; j++){
		        		originDistance = mui.util.distanceLatLng(passengerOriginCoords.lat, passengerOriginCoords.lng, coordsLat[i], coordsLng[j], "kilometros");
		            	distances.push(originDistance);
	        		}
	        	}
	        	console.log(distances);
	        	for (var i=0; i<distances.length; i++) {
	        		if (distances[i] < shortestDistance) {
	        			shortestDistance = distances[i];
	        		}
	        	}
	        	index = distances.indexOf(shortestDistance);
	          	joinCoords = {
	            	lat: coordsLat[index],
	            	lng: coordsLng[index]
	          	}
	          	return joinCoords;
	        }
		    
	    </script>
	    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDR88H93LUtHFj1uCVZNMCr64bxjYOD844&callback=initMap"></script>
    	<script src="gmaps/gmaps.js"></script>
    	<!-- <script src="gmaps/map.js"></script>  -->
	</body>
</html>